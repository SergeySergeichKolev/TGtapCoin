<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>TapCoin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      :root {
        --bg-primary: #0a0a0f;
        --bg-secondary: #12121a;
        --gold: #f5c542;
        --gold-bright: #ffe066;
        --gold-dark: #c49a1a;
        --text-primary: #ffffff;
        --text-secondary: #8888aa;
        --accent: #7b61ff;
      }

      body {
        font-family: "Outfit", sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Animated background */
      .bg-glow {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        height: 300px;
        background: radial-gradient(
          circle,
          rgba(245, 197, 66, 0.08) 0%,
          transparent 70%
        );
        border-radius: 50%;
        pointer-events: none;
        z-index: 0;
        transition: transform 0.1s;
      }

      .header {
        position: relative;
        z-index: 10;
        width: 100%;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--gold));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
      }

      .user-name {
        font-weight: 600;
        font-size: 15px;
      }

      .user-rank {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .league-badge {
        background: var(--bg-secondary);
        border: 1px solid rgba(245, 197, 66, 0.2);
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 13px;
        color: var(--gold);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Score display */
      .score-section {
        position: relative;
        z-index: 10;
        text-align: center;
        margin-top: 10px;
      }

      .score-label {
        font-size: 13px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 4px;
      }

      .score-value {
        font-size: 48px;
        font-weight: 900;
        background: linear-gradient(
          180deg,
          var(--gold-bright) 0%,
          var(--gold-dark) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.1;
      }

      .score-value .coin-icon {
        display: inline-block;
        width: 36px;
        height: 36px;
        vertical-align: middle;
        margin-right: 4px;
      }

      /* Coin tap area */
      .coin-container {
        position: relative;
        z-index: 10;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
      }

      .coin {
        width: 260px;
        height: 260px;
        border-radius: 50%;
        position: relative;
        cursor: pointer;
        transition: transform 0.08s ease;
        will-change: transform;
      }

      .coin:active {
        transform: scale(0.95);
      }

      .coin-outer {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(
          from 0deg,
          #c49a1a,
          #f5c542,
          #ffe066,
          #f5c542,
          #c49a1a,
          #a07c15,
          #c49a1a,
          #f5c542,
          #ffe066,
          #f5c542,
          #c49a1a
        );
        padding: 6px;
        box-shadow:
          0 0 40px rgba(245, 197, 66, 0.3),
          0 8px 32px rgba(0, 0, 0, 0.5),
          inset 0 2px 4px rgba(255, 224, 102, 0.4);
        animation: coin-glow 3s ease-in-out infinite;
      }

      @keyframes coin-glow {
        0%,
        100% {
          box-shadow:
            0 0 40px rgba(245, 197, 66, 0.3),
            0 8px 32px rgba(0, 0, 0, 0.5);
        }
        50% {
          box-shadow:
            0 0 60px rgba(245, 197, 66, 0.5),
            0 8px 32px rgba(0, 0, 0, 0.5);
        }
      }

      .coin-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: radial-gradient(
          ellipse at 35% 35%,
          #ffe066 0%,
          #f5c542 25%,
          #c49a1a 60%,
          #a07c15 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .coin-inner::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent 40%,
          rgba(255, 255, 255, 0.15) 45%,
          rgba(255, 255, 255, 0.3) 50%,
          rgba(255, 255, 255, 0.15) 55%,
          transparent 60%
        );
        animation: coin-shine 4s ease-in-out infinite;
      }

      @keyframes coin-shine {
        0%,
        100% {
          transform: translate(-30%, -30%) rotate(0deg);
        }
        50% {
          transform: translate(30%, 30%) rotate(0deg);
        }
      }

      .coin-symbol {
        font-size: 80px;
        font-weight: 900;
        color: #8b6914;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.2),
          0 -1px 0 rgba(255, 224, 102, 0.6);
        z-index: 1;
        position: relative;
      }

      /* Floating +1 animation */
      .tap-feedback {
        position: absolute;
        font-size: 28px;
        font-weight: 900;
        color: var(--gold-bright);
        pointer-events: none;
        z-index: 100;
        animation: float-up 0.8s ease-out forwards;
        text-shadow: 0 2px 8px rgba(245, 197, 66, 0.5);
      }

      @keyframes float-up {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-80px) scale(1.3);
        }
      }

      /* Tap particles */
      .particle {
        position: absolute;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--gold);
        pointer-events: none;
        z-index: 99;
      }

      /* Energy bar */
      .energy-section {
        position: relative;
        z-index: 10;
        width: 100%;
        padding: 0 30px 20px;
      }

      .energy-bar-container {
        width: 100%;
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .energy-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--gold));
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .energy-info {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .energy-info .energy-value {
        color: var(--gold);
        font-weight: 700;
      }

      /* Bottom nav */
      .bottom-nav {
        position: relative;
        z-index: 10;
        width: 100%;
        display: flex;
        justify-content: space-around;
        padding: 12px 10px;
        background: var(--bg-secondary);
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.2s;
        padding: 4px 12px;
      }

      .nav-item.active {
        color: var(--gold);
      }

      .nav-item svg {
        width: 24px;
        height: 24px;
      }

      /* Stats panel */
      .stats-row {
        display: flex;
        gap: 8px;
        padding: 0 20px;
        margin-top: 8px;
        width: 100%;
      }

      .stat-card {
        flex: 1;
        background: var(--bg-secondary);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 10px;
        text-align: center;
      }

      .stat-card .stat-val {
        font-size: 18px;
        font-weight: 700;
        color: var(--gold);
      }

      .stat-card .stat-label {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
      }

      /* Leaderboard overlay */
      .overlay {
        position: fixed;
        inset: 0;
        background: var(--bg-primary);
        z-index: 200;
        display: none;
        flex-direction: column;
        animation: slideUp 0.3s ease;
      }

      .overlay.show {
        display: flex;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .overlay-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .overlay-title {
        font-size: 20px;
        font-weight: 700;
      }

      .close-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .leaderboard-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px 20px;
      }

      .lb-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 6px;
        background: var(--bg-secondary);
      }

      .lb-item.me {
        border: 1px solid rgba(245, 197, 66, 0.3);
      }

      .lb-rank {
        width: 28px;
        font-weight: 700;
        font-size: 16px;
        color: var(--text-secondary);
        text-align: center;
      }

      .lb-rank.top {
        color: var(--gold);
      }

      .lb-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--gold));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        flex-shrink: 0;
      }

      .lb-info {
        flex: 1;
      }
      .lb-name {
        font-weight: 600;
        font-size: 14px;
      }
      .lb-score {
        font-size: 13px;
        color: var(--gold);
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="bg-glow" id="bgGlow"></div>

    <!-- Header -->
    <div class="header">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="userName">Player</div>
          <div class="user-rank">Rank #<span id="userRank">‚Äî</span></div>
        </div>
      </div>
      <div class="league-badge">‚ö° Bronze</div>
    </div>

    <!-- Score -->
    <div class="score-section">
      <div class="score-label">Your Coins</div>
      <div class="score-value" id="scoreDisplay">0</div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-val" id="tapPower">+1</div>
        <div class="stat-label">per tap</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="totalTaps">0</div>
        <div class="stat-label">total taps</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="leagueLevel">1</div>
        <div class="stat-label">level</div>
      </div>
    </div>

    <!-- Coin -->
    <div class="coin-container" id="coinContainer">
      <div class="coin" id="coin">
        <div class="coin-outer">
          <div class="coin-inner">
            <span class="coin-symbol">$</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Energy -->
    <div class="energy-section">
      <div class="energy-bar-container">
        <div class="energy-bar-fill" id="energyBar" style="width: 100%"></div>
      </div>
      <div class="energy-info">
        <span>‚ö° Energy</span>
        <span
          ><span class="energy-value" id="energyValue">1000</span> /
          <span id="energyMax">1000</span></span
        >
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item active" onclick="showTab('tap')">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="12" cy="12" r="10" />
          <path d="M12 6v12M6 12h12" />
        </svg>
        Tap
      </div>
      <div class="nav-item" onclick="showTab('boost')">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
        </svg>
        Boost
      </div>
      <div class="nav-item" onclick="showTab('leaderboard')">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M12 15l-4 5H4l3-7h2l3 2zM12 15l4 5h4l-3-7h-2l-3 2z" />
          <circle cx="12" cy="7" r="4" />
        </svg>
        Top
      </div>
      <div class="nav-item" onclick="showTab('friends')">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />
        </svg>
        Friends
      </div>
    </div>

    <!-- Leaderboard Overlay -->
    <div class="overlay" id="leaderboardOverlay">
      <div class="overlay-header">
        <div class="overlay-title">üèÜ Leaderboard</div>
        <button class="close-btn" onclick="closeOverlay()">&times;</button>
      </div>
      <div class="leaderboard-list" id="leaderboardList"></div>
    </div>

    <script>
      // ===== CONFIG =====
      const API_URL = window.location.origin + "/api";
      const MAX_ENERGY = 1000;
      const ENERGY_REGEN_RATE = 3; // per second
      const TAP_ENERGY_COST = 1;
      const COINS_PER_TAP = 1;

      // ===== STATE =====
      let state = {
        coins: 0,
        energy: MAX_ENERGY,
        totalTaps: 0,
        level: 1,
        tapPower: 1,
        userId: null,
        userName: "Player",
        pendingCoins: 0,
      };

      let syncInterval = null;

      // ===== TELEGRAM INIT =====
      const tg = window.Telegram?.WebApp;

      function initTelegram() {
        if (tg) {
          tg.ready();
          tg.expand();
          tg.setHeaderColor("#0a0a0f");
          tg.setBackgroundColor("#0a0a0f");

          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            state.userId = user.id;
            state.userName = user.first_name || "Player";
            document.getElementById("userName").textContent = state.userName;
            document.getElementById("userAvatar").textContent = state.userName
              .charAt(0)
              .toUpperCase();
          }
        }

        // Fallback for testing outside Telegram
        if (!state.userId) {
          state.userId = "test_" + Math.random().toString(36).substr(2, 9);
          state.userName = "Test Player";
          document.getElementById("userName").textContent = state.userName;
          document.getElementById("userAvatar").textContent = "T";
        }

        loadState();
        startEnergyRegen();
        startSync();
      }

      // ===== LOAD / SAVE STATE =====
      async function loadState() {
        try {
          const res = await fetch(`${API_URL}/user/${state.userId}`);
          if (res.ok) {
            const data = await res.json();
            state.coins = data.coins || 0;
            state.totalTaps = data.totalTaps || 0;
            state.level = data.level || 1;
            state.tapPower = data.tapPower || 1;
            updateUI();
          }
        } catch (e) {
          console.log("Offline mode ‚Äî server unavailable");
        }
      }

      async function syncToServer() {
        if (state.pendingCoins === 0) return;
        const coinsToSync = state.pendingCoins;
        state.pendingCoins = 0;

        try {
          const res = await fetch(`${API_URL}/tap`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: state.userId,
              userName: state.userName,
              coins: coinsToSync,
              initData: tg?.initData || "",
            }),
          });
          if (res.ok) {
            const data = await res.json();
            state.coins = data.coins;
            state.level = data.level;
            state.totalTaps = data.totalTaps;
            updateUI();
          }
        } catch (e) {
          // If sync fails, add back to pending
          state.pendingCoins += coinsToSync;
        }
      }

      function startSync() {
        syncInterval = setInterval(syncToServer, 2000);
      }

      // ===== TAP HANDLING =====
      const coin = document.getElementById("coin");
      const coinContainer = document.getElementById("coinContainer");

      coin.addEventListener("pointerdown", handleTap);
      // Prevent context menu on long press
      coin.addEventListener("contextmenu", (e) => e.preventDefault());

      function handleTap(e) {
        e.preventDefault();

        if (state.energy < TAP_ENERGY_COST) {
          // Shake animation for no energy
          coin.style.animation = "none";
          coin.offsetHeight; // reflow
          coin.style.animation = "shake 0.3s ease";
          return;
        }

        // Haptic feedback
        if (tg?.HapticFeedback) {
          tg.HapticFeedback.impactOccurred("light");
        }

        // Update state
        state.coins += state.tapPower;
        state.energy -= TAP_ENERGY_COST;
        state.totalTaps++;
        state.pendingCoins += state.tapPower;

        // Visual feedback
        createTapFeedback(e.clientX, e.clientY);
        createParticles(e.clientX, e.clientY);
        updateUI();
      }

      function createTapFeedback(x, y) {
        const el = document.createElement("div");
        el.className = "tap-feedback";
        el.textContent = `+${state.tapPower}`;
        el.style.left = x - 20 + (Math.random() * 40 - 20) + "px";
        el.style.top = y - 20 + "px";
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
      }

      function createParticles(x, y) {
        for (let i = 0; i < 6; i++) {
          const p = document.createElement("div");
          p.className = "particle";
          p.style.left = x + "px";
          p.style.top = y + "px";

          const angle = (Math.PI * 2 * i) / 6 + Math.random() * 0.5;
          const dist = 40 + Math.random() * 60;
          const tx = Math.cos(angle) * dist;
          const ty = Math.sin(angle) * dist;

          p.animate(
            [
              { transform: "translate(0, 0) scale(1)", opacity: 1 },
              { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 },
            ],
            { duration: 500, easing: "ease-out" },
          );

          document.body.appendChild(p);
          setTimeout(() => p.remove(), 500);
        }
      }

      // ===== ENERGY REGEN =====
      function startEnergyRegen() {
        setInterval(() => {
          if (state.energy < MAX_ENERGY) {
            state.energy = Math.min(
              state.energy + ENERGY_REGEN_RATE,
              MAX_ENERGY,
            );
            updateEnergyUI();
          }
        }, 1000);
      }

      // ===== UI UPDATES =====
      function updateUI() {
        document.getElementById("scoreDisplay").textContent = formatNumber(
          state.coins,
        );
        document.getElementById("totalTaps").textContent = formatNumber(
          state.totalTaps,
        );
        document.getElementById("tapPower").textContent = `+${state.tapPower}`;
        document.getElementById("leagueLevel").textContent = state.level;
        updateEnergyUI();
        updateLeague();
      }

      function updateEnergyUI() {
        const pct = (state.energy / MAX_ENERGY) * 100;
        document.getElementById("energyBar").style.width = pct + "%";
        document.getElementById("energyValue").textContent = Math.floor(
          state.energy,
        );
      }

      function updateLeague() {
        const badge = document.querySelector(".league-badge");
        if (state.coins >= 100000) {
          badge.textContent = "üíé Diamond";
        } else if (state.coins >= 50000) {
          badge.textContent = "ü•á Gold";
        } else if (state.coins >= 10000) {
          badge.textContent = "ü•à Silver";
        } else {
          badge.textContent = "‚ö° Bronze";
        }
      }

      function formatNumber(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
        if (n >= 1000) return (n / 1000).toFixed(1) + "K";
        return n.toString();
      }

      // ===== TABS / NAVIGATION =====
      function showTab(tab, event) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –ø—É–Ω–∫—Ç–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω event
        if (event && event.currentTarget) {
          event.currentTarget.classList.add("active");
        }

        if (tab === "leaderboard") {
          loadLeaderboard();
        }
      }
      async function loadLeaderboard() {
        const overlay = document.getElementById("leaderboardOverlay");
        overlay.classList.add("show");

        try {
          const res = await fetch(`${API_URL}/leaderboard`);
          const data = await res.json();
          renderLeaderboard(data);
        } catch (e) {
          // Show dummy data if offline
          renderLeaderboard([
            {
              userName: state.userName,
              coins: state.coins,
              userId: state.userId,
            },
          ]);
        }
      }

      function renderLeaderboard(players) {
        const list = document.getElementById("leaderboardList");
        list.innerHTML = players
          .map(
            (p, i) => `
                <div class="lb-item ${p.userId === state.userId ? "me" : ""}">
                    <div class="lb-rank ${i < 3 ? "top" : ""}">${i < 3 ? ["ü•á", "ü•à", "ü•â"][i] : i + 1}</div>
                    <div class="lb-avatar">${(p.userName || "P").charAt(0)}</div>
                    <div class="lb-info">
                        <div class="lb-name">${p.userName || "Anonymous"}</div>
                        <div class="lb-score">${formatNumber(p.coins)} coins</div>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function closeOverlay() {
        document.getElementById("leaderboardOverlay").classList.remove("show");
      }

      // ===== INIT =====
      initTelegram();
    </script>
  </body>
</html>
